<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispatch System Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styling */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a2e; /* Dark background */
            color: #e0e0e0; /* Light text color */
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevent body scroll, content will scroll if needed */
            position: relative; /* Needed for absolute positioning of top-corner elements and loading overlay */
        }

        /* Initial display state: Dashboard elements hidden by default */
        .dashboard-container, .top-left-logo, .top-right-info {
            display: none;
        }

        /* Top-Corner Elements */
        .top-left-logo {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 50px; /* Adjust size as needed */
            height: auto;
            z-index: 100; /* Ensure it's on top */
            border-radius: 5px; /* Optional: rounded corners for the image */
        }

        .top-right-info {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex; /* To stack version and countdown */
            flex-direction: column;
            align-items: flex-end; /* Align text to the right */
            gap: 5px; /* Space between version and countdown */
        }

        .top-right-version {
            font-size: 0.8em;
            color: #90a0c0;
        }

        .top-right-countdown {
            font-size: 0.9em;
            font-weight: 500;
            color: #ffcc00; /* Yellow for update countdown */
        }


        /* Main Container for the entire dashboard */
        .dashboard-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 10px;
            gap: 10px; /* Space between top and bottom sections */
            /* Add padding to prevent content from being hidden by top-corner elements */
            padding-top: 60px; /* Adjust based on logo/version height + desired spacing */
        }

        /* Top Section Layout - Adjusted to accommodate 3 columns */
        .top-section {
            display: flex;
            gap: 10px;
            flex-grow: 1; /* Allows it to take available space */
            min-height: 0; /* Important for flex items with scrollable children */
        }

        /* Panels in Top Section */
        .top-panel-left, .top-panel-middle, .top-panel-right { /* Added top-panel-middle */
            background-color: #20203a; /* Slightly lighter dark blue */
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Flex distribution for top panels */
        .top-panel-left { /* Active Calls */
            flex: 4; /* Larger for the main call list */
        }
        .top-panel-middle { /* Active Units */
            flex: 1.5; /* Slightly larger than BOLO, but smaller than calls */
        }
        .top-panel-right { /* Active BOLOs */
            flex: 1.5; /* Dedicated space for BOLOs */
        }


        .panel-header {
            background-color: #2a2a4a; /* Darker header */
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 500;
            color: #90a0c0; /* Lighter blue for headers */
            border-bottom: 1px solid #303050;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            flex-grow: 1;
            overflow-y: auto; /* Enable vertical scrolling for content */
            padding: 0 5px; /* Padding for content, adjust as needed */
        }

        /* Table/List Styling for Top Left Panel (Active Calls) */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #282848; /* Lighter border for rows */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        .data-table th {
            background-color: #252545;
            font-weight: 400;
            color: #a0b0d0;
            position: sticky; /* Sticky headers for scrolling */
            top: 0;
            z-index: 1;
        }

        .data-table tr {
            cursor: pointer; /* Indicate rows are clickable/selectable */
        }

        .data-table tr:hover {
            background-color: #28284f; /* Hover effect for rows */
        }

        .data-table tr.active-row {
            background-color: #3a3a7a; /* Highlight active row */
            color: #ffffff;
        }
        .data-table tr.active-row td {
             font-weight: 500; /* Make text bolder for active row */
        }

        /* Unit List (Active Units) */
        .unit-list {
            padding: 10px 0;
        }

        .unit-item {
            padding: 8px 15px;
            font-size: 0.9em;
            border-bottom: 1px solid #282848;
            cursor: pointer;
        }
        .unit-item:last-child {
            border-bottom: none;
        }
        .unit-item:hover {
            background-color: #28284f;
        }
        .unit-item.active {
            background-color: #304060; /* Blueish highlight for active unit */
            color: #ffffff;
            font-weight: 500;
        }
        .unit-item .unit-id {
            font-weight: 700;
            color: #70b0e0; /* Brighter blue for unit ID */
            margin-right: 5px;
        }
        .unit-item.active .unit-id {
            color: #fff; /* White for active unit ID */
        }

        /* BOLO List (Active BOLOs) */
        .bolo-list {
            padding: 10px 0;
        }

        .bolo-item {
            padding: 8px 15px;
            font-size: 0.9em;
            border-bottom: 1px solid #282848;
            cursor: pointer;
        }
        .bolo-item:last-child {
            border-bottom: none;
        }
        .bolo-item:hover {
            background-color: #28284f;
        }
        .bolo-item .bolo-id {
            font-weight: 700;
            color: #e0b070; /* Orangeish for BOLO ID */
            margin-right: 5px;
        }
        .bolo-item .bolo-time {
            font-size: 0.8em;
            color: #90a0c0;
            margin-left: 5px;
        }


        /* Bottom Section Layout (Yellow highlighted in image) */
        .bottom-section {
            display: flex;
            gap: 10px;
            flex-shrink: 0; /* Prevent it from shrinking */
            height: 350px; /* Fixed height as per image's proportion */
            border: 2px solid #ffcc00; /* Yellow border as in image */
            border-radius: 8px; /* Match panel radius */
            overflow: hidden; /* Ensure content stays within border */
            background-color: #20203a; /* Background for the entire bottom section */
        }

        /* Left Panel in Bottom Section (Forms) */
        .bottom-panel-left {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between form sections */
            border-right: 1px solid #303050; /* Separator between forms and details */
            overflow-y: auto; /* Allow scrolling if content overflows */
        }

        .bottom-panel-left .section-title {
            font-size: 1.1em;
            font-weight: 500;
            color: #e0e0e0;
            padding-bottom: 10px;
            border-bottom: 1px solid #303050;
            margin-bottom: 15px;
        }
        .bottom-panel-left .section-title span {
            color: #ffcc00; /* Yellow for section titles */
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.8em;
            color: #90a0c0;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 8px 10px;
            background-color: #303050; /* Darker input background */
            border: 1px solid #404060;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 0.9em;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6080ff; /* Blue highlight on focus */
            box-shadow: 0 0 0 2px rgba(96, 128, 255, 0.2);
        }

        textarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 60px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px; /* Space above buttons */
            padding-top: 15px;
            border-top: 1px solid #303050;
        }
        .form-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .form-buttons .btn-primary {
            background-color: #007bff; /* Blue button */
            color: white;
        }
        .form-buttons .btn-secondary {
            background-color: #505070; /* Gray button */
            color: #e0e0e0;
        }
        .form-buttons .btn-primary:hover { background-color: #0056b3; }
        .form-buttons .btn-secondary:hover { background-color: #606080; }

        /* Specific Styling for form sections in bottom-panel-left */
        .unit-status-update-section .form-buttons,
        .new-bolo-section .form-buttons,
        .system-controls-section .form-buttons { /* Added system-controls */
            margin-top: 10px;
            border-top: none;
            padding-top: 0;
        }
        .unit-status-update-section .section-title,
        .new-bolo-section .section-title,
        .system-controls-section .section-title { /* Added system-controls */
            border-top: 1px solid #303050; /* Separator for these sections */
            padding-top: 20px;
            margin-top: 20px;
        }


        /* Right Panel in Bottom Section (e.g., Event Details) */
        .bottom-panel-right {
            flex: 1.5; /* Takes more space than left form */
            padding: 15px;
            overflow-y: auto; /* Allow scrolling for event details if long */
        }

        .detail-item {
            margin-bottom: 10px;
        }
        .detail-label {
            font-size: 0.8em;
            color: #90a0c0;
            margin-bottom: 3px;
            display: block;
        }
        .detail-value {
            font-size: 0.95em;
            color: #e0e0e0;
            font-weight: 400;
        }
        .detail-value.important {
            color: #ffcc00; /* Yellow for important values */
            font-weight: 500;
        }

        /* Utility/Helper Classes */
        .text-muted {
            color: #888;
        }
        .text-blue {
            color: #70b0e0;
        }
        .text-red {
            color: #e35d6a; /* A soft red */
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            text-transform: uppercase;
        }
        .status-badge.red {
            background-color: rgba(227, 93, 106, 0.2);
            color: #e35d6a;
        }
        .status-badge.green {
            background-color: rgba(144, 238, 144, 0.2);
            color: #90ee90;
        }
        .status-badge.blue {
            background-color: rgba(100, 149, 237, 0.2);
            color: #6495ed;
        }

        /* Scrollbar Styling (Webkit - Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbars */
        }
        ::-webkit-scrollbar-track {
            background: #282848;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #404060;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #505070;
        }

        /* Custom Context Menu Styling */
        #customContextMenu {
            display: none; /* Hidden by default */
            position: absolute;
            background-color: #3a3a7a; /* Darker background for menu */
            border: 1px solid #4a4a8a;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1000; /* Ensure it's on top of everything */
            padding: 5px 0;
            min-width: 180px;
        }

        #customContextMenu .menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
            color: #e0e0e0;
        }

        #customContextMenu .menu-item:hover {
            background-color: #4a4a8a; /* Hover effect for menu items */
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent black */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            z-index: 2000; /* Above everything else */
            transition: opacity 0.5s ease-out;
            opacity: 1;
        }
        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none; /* Allows clicks to pass through when hidden */
        }

    </style>
</head>
<body>
    <div id="loginContainer" style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #1a1a2e; /* Match body background */
        color: #e0e0e0;
        display: flex; /* Hidden by JS initially */
        justify-content: center;
        align-items: center;
        z-index: 2001; /* Higher than loading overlay */
    ">
        <div class="login-box" style="
            background-color: #20203a;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            text-align: center;
            width: 350px;
        ">
            <h2 style="color: #ffcc00; margin-bottom: 25px;">CAD System Login</h2>
            <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                <label for="usernameInput" style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #90a0c0;">USERNAME</label>
                <input type="text" id="usernameInput" placeholder="Enter username" style="
                    width: calc(100% - 20px);
                    padding: 12px 10px;
                    background-color: #303050;
                    border: 1px solid #404060;
                    border-radius: 4px;
                    color: #e0e0e0;
                    font-size: 1em;
                ">
            </div>
            <div class="form-group" style="margin-bottom: 25px; text-align: left;">
                <label for="passwordInput" style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #90a0c0;">PASSWORD</label>
                <input type="password" id="passwordInput" placeholder="Enter password" style="
                    width: calc(100% - 20px);
                    padding: 12px 10px;
                    background-color: #303050;
                    border: 1px solid #404060;
                    border-radius: 4px;
                    color: #e0e0e0;
                    font-size: 1em;
                ">
            </div>
            <button id="loginButton" style="
                width: 100%;
                padding: 12px 20px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1.1em;
                font-weight: 500;
                transition: background-color 0.2s ease;
            ">LOGIN</button>
            <div id="loginMessage" style="color: #e35d6a; margin-top: 15px; font-size: 0.9em;"></div>
        </div>
    </div>

    <div id="loadingOverlay">
        Loading Data...
    </div>

    <img src="https://media.discordapp.net/attachments/1228141326965411920/1320980715629711381/ca7eeba99227fd35efd8e37416a1680b_1.png?ex=686809e9&is=6866b869&hm=641822dd533a74995556d7f9dc2c6bd76ea3b78266177957ddda38b68cc57f56&=&format=webp&quality=lossless" alt="Logo" class="top-left-logo">
    
    <div class="top-right-info">
        <span class="top-right-version">0.0.5V</span>
        <span class="top-right-countdown" id="updateCountdownDisplay">Update 0.0.7V: Loading...</span>
    </div>

    <div class="dashboard-container">
        <div class="top-section">
            <div class="top-panel-left">
                <div class="panel-header">
                    <span>ACTIVE CALLS (<span id="activeCallsCount">0</span>)</span>
                    <span class="text-muted">FILTERS</span>
                </div>
                <div class="panel-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>TYPE</th>
                                <th>PRIORITY</th>
                                <th>ADDRESS</th>
                                <th>NOTES</th>
                                <th>TIME</th>
                                <th>UNIT</th>
                            </tr>
                        </thead>
                        <tbody id="activeCallsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="top-panel-middle">
                <div class="panel-header">
                    <span>ACTIVE UNITS</span>
                </div>
                <div class="panel-content unit-list" id="activeUnitsList">
                    </div>
            </div>

            <div class="top-panel-right">
                <div class="panel-header">
                    <span>ACTIVE BOLOS (<span id="activeBolosCount">0</span>)</span>
                </div>
                <div class="panel-content bolo-list" id="activeBolosList">
                    </div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="bottom-panel-left">
                <div class="new-event-section">
                    <div class="section-title">
                        <span>NEW CALL</span>
                    </div>
                    <div class="form-group">
                        <label for="newCallType">EVENT TYPE</label>
                        <select id="newCallType">
                            <option value="">SELECT</option>
                            <option value="MEDICAL">MEDICAL</option>
                            <option value="FIRE">FIRE</option>
                            <option value="POLICE">POLICE</option>
                            <option value="RADIO TRAFFIC">RADIO TRAFFIC</option> <option value="OTHER">OTHER</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newCallAddress">ADDRESS</label>
                        <input type="text" id="newCallAddress" placeholder="Enter address...">
                    </div>
                    <div class="form-group">
                        <label for="newCallDetails">DETAILS</label>
                        <textarea id="newCallDetails" placeholder="Provide event details..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newCallPriority">PRIORITY</label>
                        <select id="newCallPriority">
                            <option value="LOW">LOW</option>
                            <option value="MEDIUM">MEDIUM</option>
                            <option value="HIGH">HIGH</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newCallAssignedUnit">ASSIGN TO UNIT</label>
                        <input type="text" id="newCallAssignedUnit" placeholder="Unit ID or search...">
                    </div>
                    <div class="form-buttons">
                        <button class="btn-primary" id="submitNewCall">SUBMIT CALL</button>
                        <button class="btn-secondary" id="clearNewCallForm">CLEAR FORM</button>
                    </div>
                </div>

                <div class="unit-status-update-section">
                    <div class="section-title">
                        <span>UNIT STATUS UPDATE</span>
                    </div>
                    <div class="form-group">
                        <label for="unitCallsignInput">UNIT CALLSIGN</label>
                        <input type="text" id="unitCallsignInput" placeholder="e.g., E101, P205">
                    </div>
                    <div class="form-group">
                        <label for="unitStatusSelect">STATUS</label>
                        <select id="unitStatusSelect">
                            <option value="">SELECT STATUS</option>
                            <option value="10-6 Busy">10-6 Busy</option>
                            <option value="10-7 Out of Service">10-7 Out of Service</option>
                            <option value="10-8 In Service">10-8 In Service</option>
                        </select>
                    </div>
                    <div class="form-buttons">
                        <button class="btn-primary" id="updateUnitStatus">UPDATE STATUS</button>
                    </div>
                </div>

                <div class="new-bolo-section">
                    <div class="section-title">
                        <span>NEW BOLO</span>
                    </div>
                    <div class="form-group">
                        <label for="boloUnitCallsign">UNIT/BOLO ID</label>
                        <input type="text" id="boloUnitCallsign" placeholder="e.g., Car, Person, Unit A1">
                    </div>
                    <div class="form-group">
                        <label for="boloDescription">DESCRIPTION</label>
                        <textarea id="boloDescription" placeholder="Detailed description of BOLO..."></textarea>
                    </div>
                    <div class="form-buttons">
                        <button class="btn-primary" id="submitNewBolo">SUBMIT BOLO</button>
                        <button class="btn-secondary" id="clearNewBoloForm">CLEAR FORM</button>
                    </div>
                </div>

                <div class="system-controls-section">
                    <div class="section-title">
                        <span>SYSTEM CONTROLS</span>
                    </div>
                    <div class="form-buttons">
                        <button class="btn-primary" id="clearAllButton">CLEAR ALL LOGS</button>
                        <button class="btn-secondary" id="logoutButton">LOGOUT</button> </div>
                </div>
            </div>

            <div class="bottom-panel-right">
                <div class="panel-header">
                    <span id="eventDetailHeader">Event Details</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">INCIDENT TYPE</span>
                    <span class="detail-value" id="eventDetailType">N/A</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">LOCATION</span>
                    <span class="detail-value" id="eventDetailLocation">N/A</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">CALLER INFO</span>
                    <span class="detail-value" id="eventDetailCaller">N/A</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">STATUS</span>
                    <span class="detail-value"><span class="status-badge red" id="eventDetailStatus">N/A</span></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ASSIGNED UNIT(S)</span>
                    <span class="detail-value" id="eventDetailAssignedUnits">N/A</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">DISPATCHED AT</span>
                    <span class="detail-value" id="eventDetailDispatchedTime">N/A</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">NOTES</span>
                    <span class="detail-value" id="eventDetailNotes">N/A</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">CAD HISTORY</span>
                    <div class="detail-value" id="eventDetailHistory">
                        <p>No event selected.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customContextMenu">
        <div class="menu-item" id="removeActiveCallMenuItem">Remove Active Call</div>
    </div>

    <script>
        // --- Data Structures (for single-user persistence via localStorage) ---
        let activeCallsData = [];
        let activeUnitsData = [];
        let activeBolosData = [];

        // --- Get references to HTML elements ---

        // Login System Elements
        const loginContainer = document.getElementById('loginContainer');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');

        // Dashboard Elements to toggle visibility
        const dashboardContainer = document.querySelector('.dashboard-container');
        const topLeftLogo = document.querySelector('.top-left-logo');
        const topRightInfo = document.querySelector('.top-right-info');

        // Hardcoded credentials (INSECURE FOR PRODUCTION!)
        const VALID_USERNAME = 'C-100';
        const VALID_PASSWORD = '1234321'; // CHANGE THIS PASSWORD!

        // Active Calls Table
        const activeCallsTableBody = document.getElementById('activeCallsTableBody');
        const activeCallsCountSpan = document.getElementById('activeCallsCount');
        let callCounter = 0; 

        // New Call Form Elements
        const newCallType = document.getElementById('newCallType');
        const newCallAddress = document.getElementById('newCallAddress');
        const newCallDetails = document.getElementById('newCallDetails');
        const newCallPriority = document.getElementById('newCallPriority');
        const newCallAssignedUnit = document.getElementById('newCallAssignedUnit');
        const submitNewCallBtn = document.getElementById('submitNewCall');
        const clearNewCallFormBtn = document.getElementById('clearNewCallForm');

        // Active Units List
        const activeUnitsList = document.getElementById('activeUnitsList');

        // Unit Status Update Form Elements
        const unitCallsignInput = document.getElementById('unitCallsignInput');
        const unitStatusSelect = document.getElementById('unitStatusSelect');
        const updateUnitStatusBtn = document.getElementById('updateUnitStatus');

        // Active BOLOs List
        const activeBolosList = document.getElementById('activeBolosList');
        const activeBolosCountSpan = document.getElementById('activeBolosCount');
        let boloCounter = 0; 

        // New BOLO Form Elements
        const boloUnitCallsignInput = document.getElementById('boloUnitCallsign');
        const boloDescriptionTextarea = document.getElementById('boloDescription');
        const submitNewBoloBtn = document.getElementById('submitNewBolo');
        const clearNewBoloFormBtn = document.getElementById('clearNewBoloForm');

        // Event Details Panel Elements
        const eventDetailHeader = document.getElementById('eventDetailHeader');
        const eventDetailType = document.getElementById('eventDetailType');
        const eventDetailLocation = document.getElementById('eventDetailLocation');
        const eventDetailCaller = document.getElementById('eventDetailCaller');
        const eventDetailStatus = document.getElementById('eventDetailStatus');
        const eventDetailAssignedUnits = document.getElementById('eventDetailAssignedUnits');
        const eventDetailDispatchedTime = document.getElementById('eventDetailDispatchedTime');
        const eventDetailNotes = document.getElementById('eventDetailNotes');
        const eventDetailHistory = document.getElementById('eventDetailHistory');

        // Custom Context Menu Elements
        const customContextMenu = document.getElementById('customContextMenu');
        const removeActiveCallMenuItem = document.getElementById('removeActiveCallMenuItem');
        let rightClickedRow = null; 

        // Countdown Timer Elements
        const updateCountdownDisplay = document.getElementById('updateCountdownDisplay');

        // System Controls
        const clearAllButton = document.getElementById('clearAllButton');
        const logoutButton = document.getElementById('logoutButton'); // Reference for the new logout button

        // Loading Overlay
        const loadingOverlay = document.getElementById('loadingOverlay');

        // --- Functions to update display counts ---

        function updateActiveCallsCount() {
            activeCallsCountSpan.textContent = activeCallsData.length;
        }

        function updateActiveBolosCount() {
            activeBolosCountSpan.textContent = activeBolosData.length;
        }

        function clearEventDetailsPanel() {
            eventDetailHeader.textContent = 'Event Details';
            eventDetailType.textContent = 'N/A';
            eventDetailLocation.textContent = 'N/A';
            eventDetailCaller.textContent = 'N/A';
            eventDetailStatus.textContent = 'N/A';
            eventDetailStatus.className = 'status-badge'; 
            eventDetailAssignedUnits.innerHTML = 'N/A';
            eventDetailDispatchedTime.textContent = 'N/A';
            eventDetailNotes.textContent = 'N/A';
            eventDetailHistory.innerHTML = '<p>No event selected.</p>';
        }

        // --- Data Persistence (localStorage for single user) ---
        function saveAllData() {
            localStorage.setItem('activeCallsData', JSON.stringify(activeCallsData));
            localStorage.setItem('activeUnitsData', JSON.stringify(activeUnitsData));
            localStorage.setItem('activeBolosData', JSON.stringify(activeBolosData));
            localStorage.setItem('callCounter', callCounter);
            localStorage.setItem('boloCounter', boloCounter);
            console.log("Data saved to localStorage.");
        }

        function loadAllData() {
            // Calls
            const storedCalls = localStorage.getItem('activeCallsData');
            if (storedCalls) {
                activeCallsData = JSON.parse(storedCalls);
                activeCallsTableBody.innerHTML = ''; // Clear current display
                activeCallsData.forEach(call => addCallToTable(call, false)); // Re-add to DOM, don't save again
            }

            // Units
            const storedUnits = localStorage.getItem('activeUnitsData');
            if (storedUnits) {
                activeUnitsData = JSON.parse(storedUnits);
                activeUnitsList.innerHTML = ''; // Clear current display
                activeUnitsData.forEach(unit => addUnitToDisplay(unit, false)); // Re-add to DOM, don't save again
            }

            // BOLOs
            const storedBolos = localStorage.getItem('activeBolosData');
            if (storedBolos) {
                activeBolosData = JSON.parse(storedBolos);
                activeBolosList.innerHTML = ''; // Clear current display
                activeBolosData.forEach(bolo => addBoloToDisplay(bolo, false)); // Re-add to DOM, don't save again
            }

            callCounter = parseInt(localStorage.getItem('callCounter') || '0');
            boloCounter = parseInt(localStorage.getItem('boloCounter') || '0');

            updateActiveCallsCount();
            updateActiveBolosCount();
            console.log("Data loaded from localStorage.");
        }

        // --- Functions to add/update items in DOM and data arrays ---

        function addCallToTable(call, save = true) {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-call-id', call.id); // Store ID for easy lookup
            newRow.innerHTML = `
                <td>${call.id}</td>
                <td>${call.type}</td>
                <td>${call.priority}</td>
                <td>${call.address}</td>
                <td>${call.details}</td>
                <td>${call.time}</td>
                <td>${call.assignedUnit}</td>
            `;
            activeCallsTableBody.prepend(newRow); // Add to the top of the list
            
            if (save) {
                activeCallsData.unshift(call); // Add to data array
                saveAllData();
            }
            updateActiveCallsCount();
        }

        function addUnitToDisplay(unit, save = true) {
            let unitFound = false;
            activeUnitsList.querySelectorAll('.unit-item').forEach(item => {
                if (item.dataset.callsign === unit.callsign) {
                    item.innerHTML = `<span class="unit-id">${unit.callsign}</span> / ${unit.status}`;
                    unitFound = true;
                }
            });

            if (!unitFound) {
                const newUnitItem = document.createElement('div');
                newUnitItem.classList.add('unit-item');
                newUnitItem.dataset.callsign = unit.callsign; 
                newUnitItem.innerHTML = `<span class="unit-id">${unit.callsign}</span> / ${unit.status}`;
                activeUnitsList.prepend(newUnitItem); 
            }

            if (save) {
                // Update or add unit in activeUnitsData
                const existingUnitIndex = activeUnitsData.findIndex(u => u.callsign === unit.callsign);
                if (existingUnitIndex > -1) {
                    activeUnitsData[existingUnitIndex] = unit;
                } else {
                    activeUnitsData.unshift(unit); // Add new unit to the top
                }
                saveAllData();
            }
        }

        function addBoloToDisplay(bolo, save = true) {
            const newBoloItem = document.createElement('div');
            newBoloItem.classList.add('bolo-item');
            newBoloItem.setAttribute('data-bolo-id', bolo.id); // Store ID
            newBoloItem.innerHTML = `
                <span class="bolo-id">${bolo.id} (${bolo.unitId})</span>
                <span class="bolo-time">${bolo.time}</span><br>
                ${bolo.description}
            `;
            activeBolosList.prepend(newBoloItem); 

            if (save) {
                activeBolosData.unshift(bolo); 
                saveAllData();
            }
            updateActiveBolosCount(); 
        }

        // --- Countdown Timer Logic ---
        function startCountdown() {
            // Target date: 7 days from current time (Friday, July 4, 2025, 1:10:50 PM EDT + 7 days)
            // For a real release, this date would be set in stone or fetched from a server.
            const targetDate = new Date("July 11, 2025 13:10:50 EDT").getTime(); // Adjust this exact time as needed

            const countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    updateCountdownDisplay.textContent = "Update 0.0.7V: LAUNCHED!";
                    updateCountdownDisplay.style.color = '#90ee90'; // Green for launched
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                // Pad with leading zeros
                const format = (num) => String(num).padStart(2, '0');

                updateCountdownDisplay.textContent = `Update 0.0.7V: ${format(days)}d ${format(hours)}h ${format(minutes)}m ${format(seconds)}s`;
            }, 1000); 
        }


        // --- Event Listeners for Forms and Buttons ---

        submitNewCallBtn.addEventListener('click', () => {
            const type = newCallType.value;
            const address = newCallAddress.value;
            const details = newCallDetails.value;
            const priority = newCallPriority.value;
            const assignedUnit = newCallAssignedUnit.value;

            if (!type || !address || !details || !priority || !assignedUnit) {
                alert('Please fill in all "New Call" fields.');
                return;
            }

            callCounter++;
            const callId = `V${callCounter}`;
            const currentTime = new Date().toLocaleTimeString('en-US', { hour12: false });

            const newCall = {
                id: callId,
                type: type,
                address: address,
                details: details,
                priority: priority,
                assignedUnit: assignedUnit,
                time: currentTime
            };
            addCallToTable(newCall); // Adds to DOM and data array, saves

            newCallType.value = '';
            newCallAddress.value = '';
            newCallDetails.value = '';
            newCallPriority.value = 'LOW'; 
            newCallAssignedUnit.value = '';

            console.log('New Call Submitted:', newCall);
        });

        clearNewCallFormBtn.addEventListener('click', () => {
            newCallType.value = '';
            newCallAddress.value = '';
            newCallDetails.value = '';
            newCallPriority.value = 'LOW';
            newCallAssignedUnit.value = '';
        });

        updateUnitStatusBtn.addEventListener('click', () => {
            const callsign = unitCallsignInput.value.trim().toUpperCase(); 
            const status = unitStatusSelect.value;

            if (!callsign || !status) {
                alert('Please enter a Unit Callsign and select a Status.');
                return;
            }

            const unit = { callsign: callsign, status: status };
            addUnitToDisplay(unit); // Adds/updates in DOM and data array, saves

            unitCallsignInput.value = '';
            unitStatusSelect.value = '';

            console.log(`Unit Status Updated: ${callsign} to ${status}`);
        });

        submitNewBoloBtn.addEventListener('click', () => {
            const boloUnitId = boloUnitCallsignInput.value.trim().toUpperCase();
            const boloDescription = boloDescriptionTextarea.value.trim();

            if (!boloUnitId || !boloDescription) {
                alert('Please fill in both "Unit/BOLO ID" and "Description" for the New BOLO.');
                return;
            }

            boloCounter++;
            const boloId = `BOLO-${boloCounter}`;
            const currentTime = new Date().toLocaleTimeString('en-US', { hour12: false });

            const newBolo = {
                id: boloId,
                unitId: boloUnitId,
                description: boloDescription,
                time: currentTime
            };
            addBoloToDisplay(newBolo); // Adds to DOM and data array, saves

            boloUnitCallsignInput.value = '';
            boloDescriptionTextarea.value = '';

            console.log('New BOLO Submitted:', newBolo);
        });

        clearNewBoloFormBtn.addEventListener('click', () => {
            boloUnitCallsignInput.value = '';
            boloDescriptionTextarea.value = '';
        });


        // --- Event Listener for Active Calls table to show details (Left Click) ---
        activeCallsTableBody.addEventListener('click', (event) => {
            let row = event.target.closest('tr');
            if (row) {
                // Remove active class from all rows
                activeCallsTableBody.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
                // Add active class to the clicked row
                row.classList.add('active-row');

                const callId = row.getAttribute('data-call-id');
                const call = activeCallsData.find(c => c.id === callId);

                if (call) {
                    eventDetailHeader.textContent = `EVENT #${call.id}`;
                    eventDetailType.textContent = call.type;
                    eventDetailLocation.textContent = call.address;
                    
                    eventDetailStatus.textContent = call.priority;
                    eventDetailStatus.className = 'status-badge';
                    if (call.priority.toUpperCase() === 'HIGH' || call.priority.toUpperCase() === 'CRITICAL') {
                        eventDetailStatus.classList.add('red');
                    } else if (call.priority.toUpperCase() === 'MEDIUM') {
                        eventDetailStatus.classList.add('blue');
                    } else {
                        eventDetailStatus.classList.add('green');
                    }

                    eventDetailAssignedUnits.innerHTML = `${call.assignedUnit} <span class="text-muted">(assigned)</span>`;
                    eventDetailDispatchedTime.textContent = call.time;
                    eventDetailNotes.textContent = call.details;
                    eventDetailCaller.textContent = 'N/A (from log entry)';
                    eventDetailHistory.innerHTML = `<p>${call.time} - Call created by dispatcher</p>`;
                }
            }
        });

        // --- Custom Context Menu Logic for Active Calls (Right Click) ---
        activeCallsTableBody.addEventListener('contextmenu', (event) => {
            const row = event.target.closest('tr'); 
            if (row) {
                event.preventDefault(); 
                rightClickedRow = row; 

                customContextMenu.style.left = `${event.clientX}px`;
                customContextMenu.style.top = `${event.clientY}px`;
                customContextMenu.style.display = 'block'; 

                activeCallsTableBody.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
                row.classList.add('active-row');
            } else {
                customContextMenu.style.display = 'none';
            }
        });

        document.addEventListener('click', (event) => {
            if (customContextMenu.style.display === 'block' && !customContextMenu.contains(event.target)) {
                customContextMenu.style.display = 'none';
            }
        });

        removeActiveCallMenuItem.addEventListener('click', () => {
            if (rightClickedRow) {
                const callIdToDelete = rightClickedRow.getAttribute('data-call-id');
                
                // Remove from data array
                activeCallsData = activeCallsData.filter(call => call.id !== callIdToDelete);
                saveAllData();

                // Clear details if the deleted call was displayed
                if (rightClickedRow.classList.contains('active-row')) {
                    clearEventDetailsPanel();
                }
                rightClickedRow.remove(); 
                updateActiveCallsCount(); 
                rightClickedRow = null; 
            }
            customContextMenu.style.display = 'none'; 
        });

        // --- Clear All Logs Functionality ---
        clearAllButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all active calls, units, and BOLOs? This action cannot be undone.')) {
                clearAllLogs(true); // Pass true to also clear login status if desired, or false to remain logged in
            }
        });

        function clearAllLogs(shouldClearLogin = false) { // Added parameter
            // Clear data arrays
            activeCallsData = [];
            activeUnitsData = [];
            activeBolosData = [];

            // Clear DOM elements
            activeCallsTableBody.innerHTML = '';
            activeUnitsList.innerHTML = '';
            activeBolosList.innerHTML = '';

            // Reset counters
            callCounter = 0;
            boloCounter = 0;

            // Clear localStorage, but conditionally keep 'isLoggedIn'
            const isLoggedInStatus = localStorage.getItem('isLoggedIn');
            localStorage.clear();
            if (!shouldClearLogin && isLoggedInStatus) { // If we shouldn't clear login, restore it
                localStorage.setItem('isLoggedIn', isLoggedInStatus);
            }

            // Update display counts
            updateActiveCallsCount();
            updateActiveBolosCount();

            // Clear details panel
            clearEventDetailsPanel();

            // Clear form fields
            newCallType.value = '';
            newCallAddress.value = '';
            newCallDetails.value = '';
            newCallPriority.value = 'LOW';
            newCallAssignedUnit.value = '';
            unitCallsignInput.value = '';
            unitStatusSelect.value = '';
            boloUnitCallsignInput.value = '';
            boloDescriptionTextarea.value = '';

            console.log("All logs and data cleared.");
        }


        // --- Login/Logout Functions ---

        function showLogin() {
            loginContainer.style.display = 'flex';
            dashboardContainer.style.display = 'none';
            topLeftLogo.style.display = 'none';
            topRightInfo.style.display = 'none';
            loadingOverlay.classList.add('hidden'); // Ensure loading overlay is hidden for login
            usernameInput.focus();
        }

        function showDashboard() {
            loginContainer.style.display = 'none';
            dashboardContainer.style.display = 'flex'; // Restore original display property
            topLeftLogo.style.display = 'block'; // Restore original display property
            topRightInfo.style.display = 'flex'; // Restore original display property
            // We'll manage loadingOverlay in initializeDashboard
        }

        function performLogin() {
            const enteredUsername = usernameInput.value;
            const enteredPassword = passwordInput.value;

            if (enteredUsername === VALID_USERNAME && enteredPassword === VALID_PASSWORD) {
                localStorage.setItem('isLoggedIn', 'true'); // Set a flag in local storage
                loginMessage.textContent = '';
                usernameInput.value = '';
                passwordInput.value = '';
                initializeDashboard(); // Load data and show dashboard
            } else {
                loginMessage.textContent = 'Invalid username or password.';
            }
        }

        function performLogout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('isLoggedIn'); // Clear the login flag
                clearAllLogs(true); // Clear all data and also the login status
                showLogin(); // Go back to the login screen
                console.log('User logged out.');
            }
        }

        // --- Event Listeners for Login/Logout ---
        loginButton.addEventListener('click', performLogin);

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                passwordInput.focus();
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performLogin();
            }
        });

        // Add this check in case the button wasn't added in HTML (though it should be now)
        if (logoutButton) {
            logoutButton.addEventListener('click', performLogout);
        }


        // --- Initial setup on page load ---
        function initializeDashboard() {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                // Show loading overlay only if we're actually loading the dashboard
                loadingOverlay.classList.remove('hidden');
                showDashboard(); // Make dashboard visible

                // Simulate loading time (e.g., fetching from a server or just processing local data)
                setTimeout(() => {
                    loadAllData(); // Load data from localStorage
                    updateActiveCallsCount(); 
                    updateActiveBolosCount(); 
                    clearEventDetailsPanel(); 
                    startCountdown(); // Start the 7-day countdown

                    // Hide loading overlay after data is loaded and rendered
                    loadingOverlay.classList.add('hidden');
                }, 1000); // Hide after 1 second (adjust as needed)
            } else {
                // If not logged in, show the login screen
                showLogin();
            }
        }

        // Call initialization function on page load
        initializeDashboard();
    </script>
</body>
</html>
