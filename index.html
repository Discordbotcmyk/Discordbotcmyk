<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dispatch System</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #dashboardContainer, #loginContainer { display: none; }
  #dashboardContainer.fade-in { animation: fadeIn 1s ease forwards; }
  .fade-in { animation: fadeIn 1s ease forwards; }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  .active-row { background-color: #f0f8ff; }
  .status-badge { padding: 3px 6px; border-radius: 3px; color: white; font-weight: bold; }
  .status-badge.red { background-color: #d9534f; }
  .status-badge.blue { background-color: #0275d8; }
  .status-badge.green { background-color: #5cb85c; }
  .unit-item, .bolo-item { padding: 5px; border: 1px solid #ccc; margin-bottom: 4px; border-radius: 3px; }
  #customContextMenu { position: fixed; background: white; border: 1px solid #aaa; display: none; z-index: 1000; }
  #customContextMenu ul { list-style: none; margin: 0; padding: 0; }
  #customContextMenu ul li { padding: 8px 12px; cursor: pointer; }
  #customContextMenu ul li:hover { background-color: #eee; }
  .message { margin-top: 10px; }
  .message.success { color: green; }
  .message.error { color: red; }
  #adminPanelContent { display: none; border: 1px solid #ccc; padding: 10px; margin-top: 5px; background: #fafafa; }
  .list-group-item { cursor: pointer; padding: 5px; border-bottom: 1px solid #ddd; }
  .list-group-item.selected-user { background-color: #cce5ff; }
  .user-item-actions button { margin-left: 5px; }
  #loadingOverlay {
    position: fixed; top:0; left:0; right:0; bottom:0;
    background: rgba(255,255,255,0.9);
    display: flex; justify-content: center; align-items: center;
    font-size: 1.5em;
    z-index: 2000;
  }
  #loadingOverlay.hidden { display: none; }
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loadingOverlay" class="hidden">Loading...</div>

<!-- Login Container -->
<div id="loginContainer" style="display:flex; flex-direction: column; max-width: 300px;">
  <h2>Login</h2>
  <input id="usernameInput" placeholder="Username" autocomplete="username" />
  <input id="passwordInput" type="password" placeholder="Password" autocomplete="current-password" />
  <button id="loginButton">Login</button>
  <div id="loginMessage" style="color:red; margin-top: 5px;"></div>
</div>

<!-- Dashboard Container -->
<div id="dashboardContainer" style="flex-direction: column;">
  <header style="display:flex; justify-content: space-between; align-items: center;">
    <h1>Dispatch Dashboard</h1>
    <button id="logoutButton">Logout</button>
  </header>

  <!-- Active Calls Section -->
  <section>
    <h2>Active Calls (<span id="activeCallsCount">0</span>)</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Type</th><th>Priority</th><th>Address</th><th>Details</th><th>Time</th><th>Assigned Unit</th>
        </tr>
      </thead>
      <tbody id="activeCallsTableBody"></tbody>
    </table>
  </section>

  <!-- Active Units Section -->
  <section>
    <h2>Active Units</h2>
    <div id="activeUnitsList"></div>
  </section>

  <!-- Active BOLOs Section -->
  <section>
    <h2>Active BOLOs (<span id="activeBolosCount">0</span>)</h2>
    <div id="activeBolosList"></div>
  </section>

  <!-- Event Detail Panel -->
  <section id="eventDetailsPanel" style="border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
    <h3 id="eventDetailHeader">Select a call to see details</h3>
    <p><strong>Type:</strong> <span id="eventDetailType"></span></p>
    <p><strong>Location:</strong> <span id="eventDetailLocation"></span></p>
    <p><strong>Status:</strong> <span id="eventDetailStatus" class="status-badge"></span></p>
    <p><strong>Assigned Units:</strong> <span id="eventDetailAssignedUnits"></span></p>
    <p><strong>Dispatched Time:</strong> <span id="eventDetailDispatchedTime"></span></p>
    <p><strong>Notes:</strong> <span id="eventDetailNotes"></span></p>
    <p><strong>Caller:</strong> <span id="eventDetailCaller"></span></p>
    <p><strong>History:</strong> <span id="eventDetailHistory"></span></p>
  </section>

  <!-- Forms to add calls, units, bolos (simplified) -->
  <section style="margin-top: 20px;">
    <h3>New Call</h3>
    <input id="newCallType" placeholder="Type" />
    <input id="newCallAddress" placeholder="Address" />
    <input id="newCallDetails" placeholder="Details" />
    <select id="newCallPriority">
      <option value="LOW">LOW</option>
      <option value="MEDIUM">MEDIUM</option>
      <option value="HIGH">HIGH</option>
      <option value="CRITICAL">CRITICAL</option>
    </select>
    <input id="newCallAssignedUnit" placeholder="Assigned Unit" />
    <button id="submitNewCallBtn">Submit Call</button>
    <button id="clearNewCallFormBtn">Clear</button>
  </section>

  <section style="margin-top: 20px;">
    <h3>Update Unit Status</h3>
    <input id="unitCallsignInput" placeholder="Unit Callsign" />
    <select id="unitStatusSelect">
      <option value="">Select Status</option>
      <option value="Available">Available</option>
      <option value="Busy">Busy</option>
      <option value="Out of Service">Out of Service</option>
    </select>
    <button id="updateUnitStatusBtn">Update Status</button>
  </section>

  <section style="margin-top: 20px;">
    <h3>New BOLO</h3>
    <input id="boloUnitCallsignInput" placeholder="Unit/BOLO ID" />
    <textarea id="boloDescriptionTextarea" placeholder="Description"></textarea><br />
    <button id="submitNewBoloBtn">Submit BOLO</button>
    <button id="clearNewBoloFormBtn">Clear</button>
  </section>

  <button id="clearAllButton" style="margin-top: 20px;">Clear All Logs</button>

  <!-- Admin Panel -->
  <section style="margin-top: 30px;">
    <h2 id="adminPanelHeader" style="cursor:pointer; user-select:none;">
      Admin Panel <span style="font-size: 0.8em;">(Click to toggle)</span>
    </h2>
    <div id="adminPanelContent">

      <h3>Manage Users</h3>
      <ul id="adminUsersList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px;">
        <!-- Admin users list -->
      </ul>
      <input id="newAdminUsernameInput" placeholder="Username" />
      <input id="newAdminPasswordInput" type="password" placeholder="Password" />
      <button id="addAdminUserBtn">Add User</button>
      <button id="updateAdminUserBtn">Update User</button>
      <button id="removeAdminUserBtn">Remove User</button>
      <div id="adminUserMessage" class="message"></div>

      <!-- IP Ban Management -->
      <div id="admin-ip-ban-section" style="margin-top:20px;">
        <h3>IP Ban Management</h3>
        <input type="text" id="banIpInput" placeholder="Enter IP to ban" />
        <button id="banIpBtn">Ban IP</button>
        <button id="unbanIpBtn">Unban Selected IP</button>
        <ul id="bannedIpList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px;"></ul>
      </div>

      <!-- Login Logs -->
      <div id="admin-login-log-section" style="margin-top:20px;">
        <h3>Login Attempts Log (Last 100)</h3>
        <div id="loginLogList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; font-size: 12px; font-family: monospace;"></div>
      </div>

    </div>
  </section>

  <!-- Custom Context Menu -->
  <div id="customContextMenu">
    <ul>
      <li id="removeActiveCallMenuItem">Remove Call</li>
    </ul>
  </div>
</div>

<script>
  // ====== VARIABLES ======
  const ADMIN_PANEL_CODE = "admin123"; // Change as needed for admin code
  let activeCallsData = [];
  let activeUnitsData = [];
  let activeBolosData = [];
  let userAccounts = [{ username: "C-100", password: "1234321" }]; // Default user
  let bannedIPs = [];
  let loginLogs = [];
  let callCounter = 0;
  let boloCounter = 0;
  let selectedAdminUser = null;
  let rightClickedRow = null;
  let selectedBannedIP = null;

  // ====== DOM ELEMENTS ======
  const activeCallsTableBody = document.getElementById('activeCallsTableBody');
  const activeUnitsList = document.getElementById('activeUnitsList');
  const activeBolosList = document.getElementById('activeBolosList');
  const activeCallsCount = document.getElementById('activeCallsCount');
  const activeBolosCount = document.getElementById('activeBolosCount');

  const eventDetailHeader = document.getElementById('eventDetailHeader');
  const eventDetailType = document.getElementById('eventDetailType');
  const eventDetailLocation = document.getElementById('eventDetailLocation');
  const eventDetailStatus = document.getElementById('eventDetailStatus');
  const eventDetailAssignedUnits = document.getElementById('eventDetailAssignedUnits');
  const eventDetailDispatchedTime = document.getElementById('eventDetailDispatchedTime');
  const eventDetailNotes = document.getElementById('eventDetailNotes');
  const eventDetailCaller = document.getElementById('eventDetailCaller');
  const eventDetailHistory = document.getElementById('eventDetailHistory');

  const newCallType = document.getElementById('newCallType');
  const newCallAddress = document.getElementById('newCallAddress');
  const newCallDetails = document.getElementById('newCallDetails');
  const newCallPriority = document.getElementById('newCallPriority');
  const newCallAssignedUnit = document.getElementById('newCallAssignedUnit');
  const submitNewCallBtn = document.getElementById('submitNewCallBtn');
  const clearNewCallFormBtn = document.getElementById('clearNewCallFormBtn');

  const unitCallsignInput = document.getElementById('unitCallsignInput');
  const unitStatusSelect = document.getElementById('unitStatusSelect');
  const updateUnitStatusBtn = document.getElementById('updateUnitStatusBtn');

  const boloUnitCallsignInput = document.getElementById('boloUnitCallsignInput');
  const boloDescriptionTextarea = document.getElementById('boloDescriptionTextarea');
  const submitNewBoloBtn = document.getElementById('submitNewBoloBtn');
  const clearNewBoloFormBtn = document.getElementById('clearNewBoloFormBtn');

  const clearAllButton = document.getElementById('clearAllButton');

  const loginContainer = document.getElementById('loginContainer');
  const dashboardContainer = document.getElementById('dashboardContainer');
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginButton = document.getElementById('loginButton');
  const loginMessage = document.getElementById('loginMessage');
  const logoutButton = document.getElementById('logoutButton');
  const loadingOverlay = document.getElementById('loadingOverlay');

  const adminPanelHeader = document.getElementById('adminPanelHeader');
  const adminPanelContent = document.getElementById('adminPanelContent');
  const adminUsersList = document.getElementById('adminUsersList');
  const newAdminUsernameInput = document.getElementById('newAdminUsernameInput');
  const newAdminPasswordInput = document.getElementById('newAdminPasswordInput');
  const addAdminUserBtn = document.getElementById('addAdminUserBtn');
  const updateAdminUserBtn = document.getElementById('updateAdminUserBtn');
  const removeAdminUserBtn = document.getElementById('removeAdminUserBtn');
  const adminUserMessage = document.getElementById('adminUserMessage');

  const customContextMenu = document.getElementById('customContextMenu');
  const removeActiveCallMenuItem = document.getElementById('removeActiveCallMenuItem');

  const banIpInput = document.getElementById('banIpInput');
  const banIpBtn = document.getElementById('banIpBtn');
  const unbanIpBtn = document.getElementById('unbanIpBtn');
  const bannedIpList = document.getElementById('bannedIpList');

  const loginLogList = document.getElementById('loginLogList');

  // ====== FUNCTIONS ======

  function saveAllData() {
    localStorage.setItem('activeCallsData', JSON.stringify(activeCallsData));
    localStorage.setItem('activeUnitsData', JSON.stringify(activeUnitsData));
    localStorage.setItem('activeBolosData', JSON.stringify(activeBolosData));
    localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
    localStorage.setItem('callCounter', callCounter.toString());
    localStorage.setItem('boloCounter', boloCounter.toString());

    localStorage.setItem('bannedIPs', JSON.stringify(bannedIPs));
    localStorage.setItem('loginLogs', JSON.stringify(loginLogs));
  }

  function loadAllData() {
    const storedCalls = localStorage.getItem('activeCallsData');
    if (storedCalls) {
      activeCallsData = JSON.parse(storedCalls);
      activeCallsTableBody.innerHTML = '';
      activeCallsData.forEach(call => addCallToTable(call, false));
    }

    const storedUnits = localStorage.getItem('activeUnitsData');
    if (storedUnits) {
      activeUnitsData = JSON.parse(storedUnits);
      activeUnitsList.innerHTML = '';
      activeUnitsData.forEach(unit => addUnitToDisplay(unit, false));
    }

    const storedBolos = localStorage.getItem('activeBolosData');
    if (storedBolos) {
      activeBolosData = JSON.parse(storedBolos);
      activeBolosList.innerHTML = '';
      activeBolosData.forEach(bolo => addBoloToDisplay(bolo, false));
    }

    callCounter = parseInt(localStorage.getItem('callCounter') || '0');
    boloCounter = parseInt(localStorage.getItem('boloCounter') || '0');

    const storedUserAccounts = localStorage.getItem('userAccounts');
    if (storedUserAccounts) {
      userAccounts = JSON.parse(storedUserAccounts);
      displayAdminUsers();
    } else {
      saveAllData();
    }

    const storedBannedIPs = localStorage.getItem('bannedIPs');
    bannedIPs = storedBannedIPs ? JSON.parse(storedBannedIPs) : [];

    const storedLoginLogs = localStorage.getItem('loginLogs');
    loginLogs = storedLoginLogs ? JSON.parse(storedLoginLogs) : [];

    updateActiveCallsCount();
    updateActiveBolosCount();

    console.log("Data loaded from localStorage.");
  }

  // Call this after loading data to update counters
  function updateActiveCallsCount() {
    activeCallsCount.textContent = activeCallsData.length.toString();
  }
  function updateActiveBolosCount() {
    activeBolosCount.textContent = activeBolosData.length.toString();
  }

  // Clear details panel
  function clearEventDetailsPanel() {
    eventDetailHeader.textContent = 'Select a call to see details';
    eventDetailType.textContent = '';
    eventDetailLocation.textContent = '';
    eventDetailStatus.textContent = '';
    eventDetailStatus.className = 'status-badge';
    eventDetailAssignedUnits.textContent = '';
    eventDetailDispatchedTime.textContent = '';
    eventDetailNotes.textContent = '';
    eventDetailCaller.textContent = '';
    eventDetailHistory.textContent = '';
  }

  // Add call to DOM and optionally to array & save
  function addCallToTable(call, save = true) {
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-call-id', call.id);
    newRow.innerHTML = `
      <td>${call.id}</td>
      <td>${call.type}</td>
      <td>${call.priority}</td>
      <td>${call.address}</td>
      <td>${call.details}</td>
      <td>${call.time}</td>
      <td>${call.assignedUnit || ''}</td>
    `;
    newRow.addEventListener('click', () => {
      // Show details
      eventDetailHeader.textContent = `Call #${call.id} Details`;
      eventDetailType.textContent = call.type;
      eventDetailLocation.textContent = call.address;
      eventDetailStatus.textContent = call.priority;
      eventDetailStatus.className = 'status-badge ' + (call.priority.toLowerCase() === 'critical' ? 'red' : 'blue');
      eventDetailAssignedUnits.textContent = call.assignedUnit || 'None';
      eventDetailDispatchedTime.textContent = call.time;
      eventDetailNotes.textContent = call.details;
      eventDetailCaller.textContent = call.caller || 'Unknown';
      eventDetailHistory.textContent = call.history || 'N/A';
    });

    // Context menu for removing call
    newRow.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      rightClickedRow = call;
      customContextMenu.style.top = `${e.clientY}px`;
      customContextMenu.style.left = `${e.clientX}px`;
      customContextMenu.style.display = 'block';
    });

    activeCallsTableBody.appendChild(newRow);
    if (save) {
      activeCallsData.push(call);
      saveAllData();
      updateActiveCallsCount();
    }
  }

  function addUnitToDisplay(unit, save = true) {
    const div = document.createElement('div');
    div.className = 'unit-item';
    div.textContent = `Callsign: ${unit.callsign}, Status: ${unit.status}`;
    activeUnitsList.appendChild(div);
    if (save) {
      activeUnitsData.push(unit);
      saveAllData();
    }
  }

  function addBoloToDisplay(bolo, save = true) {
    const div = document.createElement('div');
    div.className = 'bolo-item';
    div.textContent = `ID: ${bolo.id}, Description: ${bolo.description}`;
    activeBolosList.appendChild(div);
    if (save) {
      activeBolosData.push(bolo);
      saveAllData();
      updateActiveBolosCount();
    }
  }

  // Admin users list display
  function displayAdminUsers() {
    adminUsersList.innerHTML = '';
    userAccounts.forEach(user => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = user.username;
      li.setAttribute('data-username', user.username);
      adminUsersList.appendChild(li);
    });
  }

  // Handle admin user actions
  function handleUserAction(action) {
    const username = newAdminUsernameInput.value.trim();
    const password = newAdminPasswordInput.value;

    if (!username || !password) {
      adminUserMessage.textContent = 'Username and password required.';
      adminUserMessage.className = 'message error';
      return;
    }

    const existingUserIndex = userAccounts.findIndex(u => u.username === username);

    if (action === 'add') {
      if (existingUserIndex !== -1) {
        adminUserMessage.textContent = 'User already exists.';
        adminUserMessage.className = 'message error';
        return;
      }
      userAccounts.push({ username, password });
      displayAdminUsers();
      saveAllData();
      adminUserMessage.textContent = 'User added.';
      adminUserMessage.className = 'message success';
    } else if (action === 'update') {
      if (existingUserIndex === -1) {
        adminUserMessage.textContent = 'User not found.';
        adminUserMessage.className = 'message error';
        return;
      }
      userAccounts[existingUserIndex].password = password;
      displayAdminUsers();
      saveAllData();
      adminUserMessage.textContent = 'User updated.';
      adminUserMessage.className = 'message success';
    } else if (action === 'remove') {
      if (existingUserIndex === -1) {
        adminUserMessage.textContent = 'User not found.';
        adminUserMessage.className = 'message error';
        return;
      }
      userAccounts.splice(existingUserIndex, 1);
      displayAdminUsers();
      saveAllData();
      adminUserMessage.textContent = 'User removed.';
      adminUserMessage.className = 'message success';
    }

    newAdminUsernameInput.value = '';
    newAdminPasswordInput.value = '';
  }

  // Remove active call by ID
  function removeActiveCallById(id) {
    activeCallsData = activeCallsData.filter(c => c.id !== id);
    saveAllData();
    updateActiveCallsCount();
    // Remove from table DOM
    const row = activeCallsTableBody.querySelector(`tr[data-call-id="${id}"]`);
    if (row) row.remove();
    clearEventDetailsPanel();
  }

  // Login attempt logging helper
  function logLoginAttempt(username, ip, success) {
    const time = new Date().toLocaleString();
    loginLogs.unshift({ username, ip, time, success });
    if (loginLogs.length > 100) loginLogs.pop();
    saveAllData();
  }

  // IP Ban management UI
  function displayBannedIPs() {
    bannedIpList.innerHTML = '';
    bannedIPs.forEach(ip => {
      const li = document.createElement('li');
      li.textContent = ip;
      li.style.cursor = 'pointer';
      li.addEventListener('click', () => {
        bannedIpList.querySelectorAll('li').forEach(item => item.style.backgroundColor = '');
        li.style.backgroundColor = '#f0a';
        selectedBannedIP = ip;
      });
      bannedIpList.appendChild(li);
    });
  }

  function displayLoginLogs() {
    loginLogList.innerHTML = '';
    loginLogs.forEach(log => {
      const div = document.createElement('div');
      div.textContent = `[${log.time}] User: ${log.username || 'N/A'}, IP: ${log.ip}, Success: ${log.success}`;
      div.style.color = log.success ? 'green' : 'red';
      loginLogList.appendChild(div);
    });
  }

  function refreshAdminIPBanSection() {
    displayBannedIPs();
    displayLoginLogs();
  }

  // ====== EVENT LISTENERS ======

  // Login button click
  loginButton.addEventListener('click', () => performLogin());

  // Enter key triggers login
  [usernameInput, passwordInput].forEach(input =>
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') performLogin();
    })
  );

  // Logout button
  logoutButton.addEventListener('click', () => {
    localStorage.setItem('isLoggedIn', 'false');
    showLogin();
  });

  // Admin panel toggle
  adminPanelHeader.addEventListener('click', () => {
    const enteredCode = prompt("Enter Admin Code:");
    if (enteredCode === ADMIN_PANEL_CODE) {
      if (adminPanelContent.style.display === 'none') {
        adminPanelContent.style.display = 'block';
        adminPanelHeader.classList.add('active');
        displayAdminUsers();
        refreshAdminIPBanSection();
      } else {
        adminPanelContent.style.display = 'none';
        adminPanelHeader.classList.remove('active');
        selectedAdminUser = null;
        adminUsersList.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('selected-user'));
      }
    } else if (enteredCode !== null) {
      alert("Incorrect Admin Code.");
    }
  });

  // Admin user list selection
  adminUsersList.addEventListener('click', (event) => {
    const listItem = event.target.closest('.list-group-item');
    if (listItem) {
      adminUsersList.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('selected-user'));
      listItem.classList.add('selected-user');
      const usernameToSelect = listItem.getAttribute('data-username');
      selectedAdminUser = userAccounts.find(u => u.username === usernameToSelect);
      if (selectedAdminUser) {
        newAdminUsernameInput.value = selectedAdminUser.username;
        newAdminPasswordInput.value = selectedAdminUser.password;
      }
    }
  });

  // Admin user buttons
  addAdminUserBtn.addEventListener('click', () => handleUserAction('add'));
  updateAdminUserBtn.addEventListener('click', () => handleUserAction('update'));
  removeAdminUserBtn.addEventListener('click', () => handleUserAction('remove'));

  // IP ban buttons
  banIpBtn.addEventListener('click', () => {
    const ipToBan = banIpInput.value.trim();
    if (!ipToBan) {
      alert("Please enter a valid IP address.");
      return;
    }
    if (bannedIPs.includes(ipToBan)) {
      alert("IP is already banned.");
      return;
    }
    bannedIPs.unshift(ipToBan);
    saveAllData();
    displayBannedIPs();
    banIpInput.value = '';
    alert(`IP ${ipToBan} has been banned.`);
  });

  unbanIpBtn.addEventListener('click', () => {
    if (!selectedBannedIP) {
      alert("Please select an IP from the list to unban.");
      return;
    }
    bannedIPs = bannedIPs.filter(ip => ip !== selectedBannedIP);
    saveAllData();
    displayBannedIPs();
    selectedBannedIP = null;
    alert("Selected IP has been unbanned.");
  });

  // Clear all logs button
  clearAllButton.addEventListener('click', () => {
    if (confirm("Clear all active calls, units, and BOLOs?")) {
      activeCallsData = [];
      activeUnitsData = [];
      activeBolosData = [];
      saveAllData();
      activeCallsTableBody.innerHTML = '';
      activeUnitsList.innerHTML = '';
      activeBolosList.innerHTML = '';
      updateActiveCallsCount();
      updateActiveBolosCount();
      clearEventDetailsPanel();
    }
  });

  // Submit new call
  submitNewCallBtn.addEventListener('click', () => {
    const type = newCallType.value.trim();
    const address = newCallAddress.value.trim();
    const details = newCallDetails.value.trim();
    const priority = newCallPriority.value;
    const assignedUnit = newCallAssignedUnit.value.trim();
    if (!type || !address || !priority) {
      alert('Please fill out at least Type, Address, and Priority.');
      return;
    }
    callCounter++;
    const time = new Date().toLocaleString();
    const newCall = {
      id: callCounter,
      type,
      priority,
      address,
      details,
      assignedUnit,
      time,
      caller: 'Unknown',
      history: 'N/A',
    };
    addCallToTable(newCall);
    updateActiveCallsCount();
    clearNewCallFormBtn.click();
  });

  // Clear new call form
  clearNewCallFormBtn.addEventListener('click', () => {
    newCallType.value = '';
    newCallAddress.value = '';
    newCallDetails.value = '';
    newCallPriority.value = 'LOW';
    newCallAssignedUnit.value = '';
  });

  // Update unit status
  updateUnitStatusBtn.addEventListener('click', () => {
    const callsign = unitCallsignInput.value.trim();
    const status = unitStatusSelect.value;
    if (!callsign || !status) {
      alert("Please enter a callsign and select a status.");
      return;
    }
    let found = false;
    activeUnitsData.forEach(unit => {
      if (unit.callsign === callsign) {
        unit.status = status;
        found = true;
      }
    });
    if (!found) {
      activeUnitsData.push({ callsign, status });
    }
    saveAllData();
    activeUnitsList.innerHTML = '';
    activeUnitsData.forEach(unit => addUnitToDisplay(unit, false));
    alert("Unit status updated.");
  });

  // Submit new BOLO
  submitNewBoloBtn.addEventListener('click', () => {
    const id = boloUnitCallsignInput.value.trim();
    const description = boloDescriptionTextarea.value.trim();
    if (!id || !description) {
      alert("Please fill out both BOLO ID and Description.");
      return;
    }
    boloCounter++;
    const newBolo = { id: `${id}-${boloCounter}`, description };
    addBoloToDisplay(newBolo);
    updateActiveBolosCount();
    clearNewBoloFormBtn.click();
  });

  // Clear new bolo form
  clearNewBoloFormBtn.addEventListener('click', () => {
    boloUnitCallsignInput.value = '';
    boloDescriptionTextarea.value = '';
  });

  // Context menu for removing active call
  document.body.addEventListener('click', () => {
    customContextMenu.style.display = 'none';
    rightClickedRow = null;
  });

  removeActiveCallMenuItem.addEventListener('click', () => {
    if (rightClickedRow) {
      removeActiveCallById(rightClickedRow.id);
      customContextMenu.style.display = 'none';
      rightClickedRow = null;
    }
  });

  // ====== LOGIN FUNCTION WITH IP FETCHING AND BAN CHECK ======
  async function performLogin() {
    try {
      loadingOverlay.classList.remove('hidden');

      // Fetch IP
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      const userIP = data.ip;

      // Check banned IPs
      if (bannedIPs.includes(userIP)) {
        alert("Your IP address is banned from this system.");
        logLoginAttempt(null, userIP, false);
        loadingOverlay.classList.add('hidden');
        return;
      }

      const enteredUsername = usernameInput.value.trim();
      const enteredPassword = passwordInput.value;

      const user = userAccounts.find(u => u.username === enteredUsername && u.password === enteredPassword);

      if (user) {
        logLoginAttempt(enteredUsername, userIP, true);
        localStorage.setItem('isLoggedIn', 'true');
        loginMessage.textContent = '';
        usernameInput.value = '';
        passwordInput.value = '';
        loadingOverlay.classList.add('hidden');
        showDashboard();
      } else {
        logLoginAttempt(enteredUsername, userIP, false);
        loginMessage.textContent = 'Invalid username or password.';
        loadingOverlay.classList.add('hidden');
      }
    } catch (error) {
      loadingOverlay.classList.add('hidden');
      alert("Could not verify IP address. Please check your internet connection.");
      console.error(error);
    }
  }

  // Show dashboard and load data
  function showDashboard() {
    loginContainer.style.display = 'none';
    dashboardContainer.style.display = 'flex';
    dashboardContainer.classList.remove('fade-in');
    loadingOverlay.classList.remove('hidden');

    setTimeout(() => {
      loadAllData();
      clearEventDetailsPanel();
      dashboardContainer.classList.add('fade-in');
      loadingOverlay.classList.add('hidden');
    }, 800);
  }

  // Show login screen
  function showLogin() {
    dashboardContainer.style.display = 'none';
    loginContainer.style.display = 'flex';
    loginMessage.textContent = '';
    usernameInput.focus();
  }

  // Initialization
  function initializeDashboard() {
    if (localStorage.getItem('isLoggedIn') === 'true') {
      showDashboard();
    } else {
      showLogin();
    }
  }

  // Call on page load
  window.onload = initializeDashboard;

</script>
</body>
</html>
